import router from '@ohos.router';
import { promptAction } from '@kit.ArkUI';

// æ‹æ‘„å‚æ•°æ¥å£
interface ShootingParameters {
  aperture: number;        // å…‰åœˆå€¼ (f/1.4, f/2.8, etc.)
  shutterSpeed: number;    // å¿«é—¨é€Ÿåº¦ (1/60, 1/125, etc.)
  iso: number;            // ISOæ„Ÿå…‰åº¦
  focalLength: number;    // ç„¦è· (mm)
  distance: number;       // æ‹æ‘„è·ç¦» (m)
}

// æ¨¡æ‹Ÿæ•ˆæœæ¥å£
interface SimulationEffect {
  exposure: number;       // æ›å…‰è¡¥å¿
  depthOfField: number;   // æ™¯æ·±æ•ˆæœ
  motionBlur: number;     // è¿åŠ¨æ¨¡ç³Š
  noise: number;          // å™ªç‚¹ç¨‹åº¦
  sharpness: number;      // é”åº¦
}

// é¢„è®¾é¡¹æ¥å£
interface PresetItem {
  name: string;
  params: ShootingParameters;
}

@Entry
@Component
struct ShootingSimulatorPage {
  @State parameters: ShootingParameters = {
    aperture: 2.8,
    shutterSpeed: 125,
    iso: 400,
    focalLength: 50,
    distance: 3
  };
  
  @State effect: SimulationEffect = {
    exposure: 0,
    depthOfField: 0.5,
    motionBlur: 0,
    noise: 0.2,
    sharpness: 0.8
  };
  
  @State selectedPreset: string = 'è‡ªå®šä¹‰';
  @State presets: Array<PresetItem> = [
    {
      name: 'äººåƒæ¨¡å¼',
      params: { aperture: 1.8, shutterSpeed: 125, iso: 200, focalLength: 85, distance: 2 }
    },
    {
      name: 'é£æ™¯æ¨¡å¼', 
      params: { aperture: 8, shutterSpeed: 60, iso: 100, focalLength: 24, distance: 50 }
    },
    {
      name: 'è¿åŠ¨æ¨¡å¼',
      params: { aperture: 4, shutterSpeed: 500, iso: 800, focalLength: 200, distance: 10 }
    },
    {
      name: 'å¤œæ™¯æ¨¡å¼',
      params: { aperture: 2.8, shutterSpeed: 4, iso: 1600, focalLength: 35, distance: 20 }
    },
    {
      name: 'å¾®è·æ¨¡å¼',
      params: { aperture: 5.6, shutterSpeed: 250, iso: 400, focalLength: 100, distance: 0.3 }
    }
  ];
  
  aboutToAppear() {
    this.updateEffect();
  }
  
  // æ›´æ–°æ¨¡æ‹Ÿæ•ˆæœ
  private updateEffect() {
    // æ ¹æ®å‚æ•°è®¡ç®—æ¨¡æ‹Ÿæ•ˆæœ
    this.effect.exposure = this.calculateExposure();
    this.effect.depthOfField = this.calculateDepthOfField();
    this.effect.motionBlur = this.calculateMotionBlur();
    this.effect.noise = this.calculateNoise();
    this.effect.sharpness = this.calculateSharpness();
  }
  
  // è®¡ç®—æ›å…‰
  private calculateExposure(): number {
    const ev = Math.log2((this.parameters.aperture * this.parameters.aperture) / (this.parameters.shutterSpeed / 1000)) - Math.log2(this.parameters.iso / 100);
    return Math.max(-3, Math.min(3, ev));
  }
  
  // è®¡ç®—æ™¯æ·±
  private calculateDepthOfField(): number {
    const hyperfocal = (this.parameters.focalLength * this.parameters.focalLength) / (this.parameters.aperture * 0.03);
    const nearLimit = (hyperfocal * this.parameters.distance) / (hyperfocal + this.parameters.distance);
    const farLimit = (hyperfocal * this.parameters.distance) / (hyperfocal - this.parameters.distance);
    const dof = Math.abs(farLimit - nearLimit);
    return Math.min(1, dof / 10);
  }
  
  // è®¡ç®—è¿åŠ¨æ¨¡ç³Š
  private calculateMotionBlur(): number {
    const motionSpeed = 5; // å‡è®¾è¿åŠ¨é€Ÿåº¦ m/s
    const blur = motionSpeed / this.parameters.shutterSpeed;
    return Math.min(1, blur / 10);
  }
  
  // è®¡ç®—å™ªç‚¹
  private calculateNoise(): number {
    return Math.min(1, (this.parameters.iso - 100) / 6300);
  }
  
  // è®¡ç®—é”åº¦
  private calculateSharpness(): number {
    const optimalAperture = 8;
    const apertureDiff = Math.abs(this.parameters.aperture - optimalAperture);
    return Math.max(0.3, 1 - apertureDiff / 10);
  }
  
  // åº”ç”¨é¢„è®¾
  private applyPreset(preset: PresetItem) {
    this.parameters = {
      aperture: preset.params.aperture,
      shutterSpeed: preset.params.shutterSpeed,
      iso: preset.params.iso,
      focalLength: preset.params.focalLength,
      distance: preset.params.distance
    };
    this.selectedPreset = preset.name;
    this.updateEffect();
  }
  
  // é‡ç½®å‚æ•°
  private resetParameters() {
    this.parameters = {
      aperture: 2.8,
      shutterSpeed: 125,
      iso: 400,
      focalLength: 50,
      distance: 3
    };
    this.selectedPreset = 'è‡ªå®šä¹‰';
    this.updateEffect();
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Image($r('app.media.icon_back'))
            .width(24)
            .height(24)
            .fillColor($r('app.color.primary_text_color'))
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          router.back();
        })
        
        Column() {
          Text('æ‹æ‘„æ¨¡æ‹Ÿå™¨')
            .fontSize(20)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.primary_text_color'))
          Text('è°ƒæ•´å‚æ•°ï¼Œå®æ—¶é¢„è§ˆæ‹æ‘„æ•ˆæœ')
            .fontSize(12)
            .fontColor($r('app.color.secondary_text_color'))
            .margin({ top: 2 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)
        
        Button('é‡ç½®')
          .fontSize(14)
          .fontColor($r('app.color.brand_color'))
          .backgroundColor(Color.Transparent)
          .onClick(() => this.resetParameters())
      }
      .width('100%')
      .height(66)
      .padding({ left: 16, right: 16 })
      .backgroundColor($r('app.color.surface_color'))
      .border({ width: { bottom: 1 }, color: $r('app.color.divider_color') })
      
      Scroll() {
        Column() {
          // é¢„è®¾æ¨¡å¼é€‰æ‹©
          Column() {
            Text('æ‹æ‘„æ¨¡å¼')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.primary_text_color'))
              .width('100%')
              .margin({ bottom: 12 })
            
            Scroll() {
              Row() {
                ForEach(this.presets, (preset: PresetItem) => {
                  Button(preset.name)
                    .fontSize(14)
                    .fontColor(this.selectedPreset === preset.name ? '#FFFFFF' : $r('app.color.brand_color'))
                    .backgroundColor(this.selectedPreset === preset.name ? $r('app.color.brand_color') : $r('app.color.background_color'))
                    .borderRadius(20)
                    .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                    .margin({ right: 12 })
                    .onClick(() => this.applyPreset(preset))
                })
                
                Button('è‡ªå®šä¹‰')
                  .fontSize(14)
                  .fontColor(this.selectedPreset === 'è‡ªå®šä¹‰' ? '#FFFFFF' : $r('app.color.brand_color'))
                  .backgroundColor(this.selectedPreset === 'è‡ªå®šä¹‰' ? $r('app.color.brand_color') : $r('app.color.background_color'))
                  .borderRadius(20)
                  .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                  .onClick(() => {
                    this.selectedPreset = 'è‡ªå®šä¹‰';
                  })
              }
            }
            .scrollable(ScrollDirection.Horizontal)
            .scrollBar(BarState.Off)
            .width('100%')
          }
          .width('100%')
          .padding(16)
          .backgroundColor($r('app.color.surface_color'))
          .borderRadius(12)
          .margin({ bottom: 16 })
          
          // æ¨¡æ‹Ÿæ•ˆæœé¢„è§ˆ
          Column() {
            Row() {
              Text('æ•ˆæœé¢„è§ˆ')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor($r('app.color.primary_text_color'))
                .layoutWeight(1)
              
              Button('ğŸ’¡ æŸ¥çœ‹å»ºè®®')
                .fontSize(12)
                .fontColor($r('app.color.brand_color'))
                .backgroundColor(Color.Transparent)
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .onClick(() => {
                  promptAction.showToast({
                    message: this.getShootingAdvice(),
                    duration: 3000
                  });
                })
            }
            .width('100%')
            .margin({ bottom: 12 })
            
            // æ¨¡æ‹Ÿå›¾åƒåŒºåŸŸ
            Stack() {
              // èƒŒæ™¯å›¾åƒ
              Image($r('app.media.foreground'))
                .width('100%')
                .height(200)
                .objectFit(ImageFit.Cover)
                .borderRadius(8)
              
              // æ•ˆæœå åŠ å±‚
              Column()
                .width('100%')
                .height(200)
                .backgroundColor(`rgba(0,0,0,${this.effect.exposure < 0 ? Math.abs(this.effect.exposure) * 0.3 : 0})`)
                .borderRadius(8)
                .blur(this.effect.motionBlur * 10)
              
              // å‚æ•°ä¿¡æ¯è¦†ç›–å±‚
              Column() {
                Text(`f/${this.parameters.aperture} â€¢ 1/${this.parameters.shutterSpeed}s â€¢ ISO${this.parameters.iso}`)
                  .fontSize(12)
                  .fontColor('#FFFFFF')
                  .backgroundColor('rgba(0,0,0,0.6)')
                  .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                  .borderRadius(4)
              }
              .width('100%')
              .height('100%')
              .justifyContent(FlexAlign.End)
              .alignItems(HorizontalAlign.Start)
              .padding(12)
            }
            .width('100%')
            .height(200)
            
            // æ•ˆæœå‚æ•°æ˜¾ç¤º
            Grid() {
              GridItem() {
                this.EffectCard('æ›å…‰', this.effect.exposure.toFixed(1), this.effect.exposure > 0 ? '#FF6B6B' : '#4ECDC4')
              }
              GridItem() {
                this.EffectCard('æ™¯æ·±', (this.effect.depthOfField * 100).toFixed(0) + '%', '#45B7D1')
              }
              GridItem() {
                this.EffectCard('è¿åŠ¨æ¨¡ç³Š', (this.effect.motionBlur * 100).toFixed(0) + '%', '#96CEB4')
              }
              GridItem() {
                this.EffectCard('å™ªç‚¹', (this.effect.noise * 100).toFixed(0) + '%', '#FECA57')
              }
            }
            .columnsTemplate('1fr 1fr')
            .rowsTemplate('1fr 1fr')
            .columnsGap(12)
            .rowsGap(12)
            .width('100%')
            .margin({ top: 16 })
          }
          .width('100%')
          .padding(16)
          .backgroundColor($r('app.color.surface_color'))
          .borderRadius(12)
          .margin({ bottom: 16 })
          
          // å‚æ•°è°ƒèŠ‚åŒºåŸŸ
          Column() {
            Text('å‚æ•°è°ƒèŠ‚')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.primary_text_color'))
              .width('100%')
              .margin({ bottom: 16 })
            
            // å…‰åœˆ
            Column() {
              Row() {
                Text('å…‰åœˆ (æ§åˆ¶æ™¯æ·±)')
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor($r('app.color.primary_text_color'))
                  .layoutWeight(1)
                Text(`f/${this.parameters.aperture.toFixed(1)}`)
                  .fontSize(14)
                  .fontColor($r('app.color.brand_color'))
                  .fontWeight(FontWeight.Medium)
              }
              .width('100%')
              .margin({ bottom: 4 })
              
              Text('æ•°å€¼è¶Šå°å…‰åœˆè¶Šå¤§ï¼ŒèƒŒæ™¯è™šåŒ–è¶Šå¼º')
                .fontSize(12)
                .fontColor($r('app.color.secondary_text_color'))
                .width('100%')
                .margin({ bottom: 8 })
              
              Slider({
                value: this.parameters.aperture,
                min: 1.4,
                max: 22,
                step: 0.1
              })
                .width('100%')
                .trackColor($r('app.color.background_color'))
                .selectedColor($r('app.color.brand_color'))
                .blockColor($r('app.color.brand_color'))
                .onChange((value: number) => {
                  this.parameters.aperture = value;
                  this.selectedPreset = 'è‡ªå®šä¹‰';
                  this.updateEffect();
                })
            }
            .width('100%')
            .margin({ bottom: 20 })
            
            // å¿«é—¨é€Ÿåº¦
            Column() {
              Row() {
                Text('å¿«é—¨é€Ÿåº¦ (æ§åˆ¶è¿åŠ¨æ¨¡ç³Š)')
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor($r('app.color.primary_text_color'))
                  .layoutWeight(1)
                Text(`1/${this.parameters.shutterSpeed.toFixed(0)}s`)
                  .fontSize(14)
                  .fontColor($r('app.color.brand_color'))
                  .fontWeight(FontWeight.Medium)
              }
              .width('100%')
              .margin({ bottom: 4 })
              
              Text('æ•°å€¼è¶Šå¤§å¿«é—¨è¶Šå¿«ï¼Œèƒ½å†»ç»“è¿åŠ¨')
                .fontSize(12)
                .fontColor($r('app.color.secondary_text_color'))
                .width('100%')
                .margin({ bottom: 8 })
              
              Slider({
                value: this.parameters.shutterSpeed,
                min: 1,
                max: 4000,
                step: 1
              })
                .width('100%')
                .trackColor($r('app.color.background_color'))
                .selectedColor($r('app.color.brand_color'))
                .blockColor($r('app.color.brand_color'))
                .onChange((value: number) => {
                  this.parameters.shutterSpeed = value;
                  this.selectedPreset = 'è‡ªå®šä¹‰';
                  this.updateEffect();
                })
            }
            .width('100%')
            .margin({ bottom: 20 })
            
            // ISO
            Column() {
              Row() {
                Text('ISOæ„Ÿå…‰åº¦ (æ§åˆ¶äº®åº¦å’Œå™ªç‚¹)')
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor($r('app.color.primary_text_color'))
                  .layoutWeight(1)
                Text(`ISO ${this.parameters.iso.toFixed(0)}`)
                  .fontSize(14)
                  .fontColor($r('app.color.brand_color'))
                  .fontWeight(FontWeight.Medium)
              }
              .width('100%')
              .margin({ bottom: 4 })
              
              Text('æ•°å€¼è¶Šé«˜è¶Šäº®ä½†å™ªç‚¹è¶Šå¤š')
                .fontSize(12)
                .fontColor($r('app.color.secondary_text_color'))
                .width('100%')
                .margin({ bottom: 8 })
              
              Slider({
                value: this.parameters.iso,
                min: 100,
                max: 6400,
                step: 100
              })
                .width('100%')
                .trackColor($r('app.color.background_color'))
                .selectedColor($r('app.color.brand_color'))
                .blockColor($r('app.color.brand_color'))
                .onChange((value: number) => {
                  this.parameters.iso = value;
                  this.selectedPreset = 'è‡ªå®šä¹‰';
                  this.updateEffect();
                })
            }
            .width('100%')
            .margin({ bottom: 20 })
            
            // ç„¦è·
            Column() {
              Row() {
                Text('ç„¦è· (æ§åˆ¶è§†è§’)')
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor($r('app.color.primary_text_color'))
                  .layoutWeight(1)
                Text(`${this.parameters.focalLength.toFixed(0)}mm`)
                  .fontSize(14)
                  .fontColor($r('app.color.brand_color'))
                  .fontWeight(FontWeight.Medium)
              }
              .width('100%')
              .margin({ bottom: 4 })
              
              Text('æ•°å€¼è¶Šå¤§è§†è§’è¶Šçª„ï¼Œæ”¾å¤§æ•ˆæœè¶Šå¼º')
                .fontSize(12)
                .fontColor($r('app.color.secondary_text_color'))
                .width('100%')
                .margin({ bottom: 8 })
              
              Slider({
                value: this.parameters.focalLength,
                min: 14,
                max: 200,
                step: 1
              })
                .width('100%')
                .trackColor($r('app.color.background_color'))
                .selectedColor($r('app.color.brand_color'))
                .blockColor($r('app.color.brand_color'))
                .onChange((value: number) => {
                  this.parameters.focalLength = value;
                  this.selectedPreset = 'è‡ªå®šä¹‰';
                  this.updateEffect();
                })
            }
            .width('100%')
            .margin({ bottom: 20 })
            
            // æ‹æ‘„è·ç¦»
            Column() {
              Row() {
                Text('æ‹æ‘„è·ç¦» (å½±å“æ™¯æ·±)')
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor($r('app.color.primary_text_color'))
                  .layoutWeight(1)
                Text(`${this.parameters.distance.toFixed(1)}m`)
                  .fontSize(14)
                  .fontColor($r('app.color.brand_color'))
                  .fontWeight(FontWeight.Medium)
              }
              .width('100%')
              .margin({ bottom: 4 })
              
              Text('è·ç¦»è¶Šè¿‘èƒŒæ™¯è™šåŒ–è¶Šå¼º')
                .fontSize(12)
                .fontColor($r('app.color.secondary_text_color'))
                .width('100%')
                .margin({ bottom: 8 })
              
              Slider({
                value: this.parameters.distance,
                min: 0.1,
                max: 100,
                step: 0.1
              })
                .width('100%')
                .trackColor($r('app.color.background_color'))
                .selectedColor($r('app.color.brand_color'))
                .blockColor($r('app.color.brand_color'))
                .onChange((value: number) => {
                  this.parameters.distance = value;
                  this.selectedPreset = 'è‡ªå®šä¹‰';
                  this.updateEffect();
                })
            }
            .width('100%')
            .margin({ bottom: 20 })
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ bottom: 16 })
          
          // æ‹æ‘„å»ºè®®
          Column() {
            Text('æ‹æ‘„å»ºè®®')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .width('100%')
              .margin({ bottom: 12 })
            
            Text(this.getShootingAdvice())
              .fontSize(14)
              .fontColor('#666666')
              .lineHeight(20)
              .width('100%')
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ bottom: 16 })
        }
      }
      .layoutWeight(1)
      .padding(16)
      .backgroundColor($r('app.color.background_color'))
    }
    .width('100%')
    .height('100%')
  }
  
  // æ•ˆæœå¡ç‰‡
  @Builder
  EffectCard(title: string, value: string, color: string) {
    Column() {
      Text(title)
        .fontSize(12)
        .fontColor($r('app.color.secondary_text_color'))
        .margin({ bottom: 4 })
      
      Text(value)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)
    }
    .width('100%')
    .padding(12)
    .backgroundColor($r('app.color.background_color'))
    .borderRadius(8)
    .justifyContent(FlexAlign.Center)
  }
  
  // å‚æ•°æ»‘å—
  @Builder
  ParameterSlider(
    title: string,
    value: string,
    currentValue: number,
    min: number,
    max: number,
    step: number,
    onChange: (value: number) => void
  ) {
    Column() {
      Row() {
        Text(title)
          .fontSize(14)
          .fontColor($r('app.color.primary_text_color'))
          .layoutWeight(1)
        
        Text(value)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.brand_color'))
      }
      .width('100%')
      .margin({ bottom: 8 })
      
      Slider({
        value: currentValue,
        min: min,
        max: max,
        step: step
      })
        .width('100%')
        .trackColor('#E5E5E5')
        .selectedColor('#007AFF')
        .blockColor('#007AFF')
        .onChange((value: number) => {
          onChange(value);
        })
    }
    .width('100%')
    .margin({ bottom: 20 })
  }
  
  // ç”Ÿæˆæ‹æ‘„å»ºè®®
  private getShootingAdvice(): string {
    let advice: string[] = [];
    
    // æ ¹æ®å…‰åœˆç»™å‡ºå»ºè®®
    if (this.parameters.aperture < 2.8) {
      advice.push('å¤§å…‰åœˆè®¾ç½®ï¼ŒèƒŒæ™¯è™šåŒ–å¼ºçƒˆï¼Œé€‚åˆäººåƒæ‹æ‘„');
    } else if (this.parameters.aperture > 8) {
      advice.push('å°å…‰åœˆè®¾ç½®ï¼Œæ™¯æ·±è¾ƒæ·±ï¼Œé€‚åˆé£æ™¯æ‹æ‘„');
    } else {
      advice.push('ä¸­ç­‰å…‰åœˆï¼Œå¹³è¡¡æ™¯æ·±å’Œé”åº¦');
    }
    
    // æ ¹æ®å¿«é—¨é€Ÿåº¦ç»™å‡ºå»ºè®®
    if (this.parameters.shutterSpeed < 60) {
      advice.push('å¿«é—¨è¾ƒæ…¢ï¼Œå»ºè®®ä½¿ç”¨ä¸‰è„šæ¶é˜²æŠ–');
    } else if (this.parameters.shutterSpeed > 500) {
      advice.push('å¿«é—¨å¾ˆå¿«ï¼Œèƒ½å†»ç»“å¿«é€Ÿè¿åŠ¨');
    }
    
    // æ ¹æ®ISOç»™å‡ºå»ºè®®
    if (this.parameters.iso < 200) {
      advice.push('ISOè¾ƒä½ï¼Œç”»è´¨æœ€ä½³ï¼Œé€‚åˆå…‰çº¿å……è¶³ç¯å¢ƒ');
    } else if (this.parameters.iso > 1600) {
      advice.push('ISOè¾ƒé«˜ï¼Œæ³¨æ„å™ªç‚¹æ§åˆ¶');
    }
    
    // æ ¹æ®ç„¦è·ç»™å‡ºå»ºè®®
    if (this.parameters.focalLength < 35) {
      advice.push('å¹¿è§’é•œå¤´ï¼Œé€‚åˆé£æ™¯å’Œå»ºç­‘æ‘„å½±');
    } else if (this.parameters.focalLength > 85) {
      advice.push('é•¿ç„¦é•œå¤´ï¼Œé€‚åˆäººåƒå’Œè¿œè·ç¦»æ‹æ‘„');
    }
    
    // æ ¹æ®æ‹æ‘„è·ç¦»ç»™å‡ºå»ºè®®
    if (this.parameters.distance < 1) {
      advice.push('è¿‘è·ç¦»æ‹æ‘„ï¼Œæ³¨æ„å¯¹ç„¦ç²¾åº¦');
    }
    
    return advice.length > 0 ? advice.join('ï¼›') : 'å½“å‰å‚æ•°è®¾ç½®åˆç†';
  }
}