import router from '@ohos.router';
import { MyEquipmentItem } from '../model/MyEquipmentModel';
import { myEquipmentService } from '../service/MyEquipmentService';
import { promptAction } from '@kit.ArkUI';
import { CameraDataItem, cameraDataJsonService } from '../service/CameraDataJsonService';
import { EnhancedCompareView } from '../components/EnhancedCompareView';

@Component
export struct ComparePage {
  @State equipmentList: MyEquipmentItem[] = [];
  @State selectedEquipment1: MyEquipmentItem | null = null;
  @State selectedEquipment2: MyEquipmentItem | null = null;
  @State showSelector1: boolean = false;
  @State showSelector2: boolean = false;
  @State allCameras: CameraDataItem[] = [];
  @State filteredCameras: CameraDataItem[] = [];
  @State searchText: string = '';
  @State selectedTab: number = 0; // 0: æˆ‘çš„å™¨æ, 1: å…¨éƒ¨ç›¸æœº
  @StorageLink('cameraToAdd') cameraToAdd: CameraDataItem | null = null;
  @State isAllCamerasLoaded: boolean = false; // æ ‡è®°å…¨éƒ¨ç›¸æœºæ˜¯å¦å·²åŠ è½½
  @State showOnlyDifferent: boolean = false; // ä»…å±•ç¤ºä¸åŒé€‰é¡¹çš„å¼€å…³
  @StorageProp('refreshMyEquipment') @Watch('onRefreshMyEquipment') refreshMyEquipment: number = 0;

  aboutToAppear() {
    this.loadEquipmentData();
    this.handleRouterParams();
    this.handleAppStorageCamera();
    this.loadAllCameras()
  }

  // ç›‘å¬æˆ‘çš„å™¨ææ•°æ®åˆ·æ–°
  onRefreshMyEquipment() {
    this.loadEquipmentData();
  }

  private async loadEquipmentData() {
    this.equipmentList = myEquipmentService.getAllEquipment();
  }

  private async loadAllCameras() {
    if (!this.isAllCamerasLoaded) {
      this.allCameras = await cameraDataJsonService.getAllCameras();
      this.filteredCameras = this.allCameras;
      this.isAllCamerasLoaded = true;
    }
  }

  private handleRouterParams() {
    const params = router.getParams() as Record<string, Object>;
    if (params && params['cameraToAdd']) {
      const cameraToAdd = params['cameraToAdd'] as CameraDataItem;
      this.addCameraToCompare(cameraToAdd);
    }
  }

  // å¤„ç†AppStorageä¼ æ¥çš„ç›¸æœºæ•°æ®
  private handleAppStorageCamera() {
    if (this.cameraToAdd) {
      this.addCameraToCompare(this.cameraToAdd);
      // æ¸…é™¤AppStorageä¸­çš„æ•°æ®
      AppStorage.setOrCreate('cameraToAdd', null);
    }
  }

  // æ·»åŠ ç›¸æœºåˆ°å¯¹æ¯”
  private addCameraToCompare(camera: CameraDataItem) {
    // å°†ä¼ å…¥çš„ç›¸æœºè½¬æ¢ä¸ºMyEquipmentItemæ ¼å¼å¹¶è‡ªåŠ¨é€‰æ‹©
    const equipmentItem: MyEquipmentItem = {
      id: Date.now(),
      equipmentName: `${camera.Brand} ${camera.Model}`,
      brand: camera.Brand,
      model: camera.Model,
      cameraDataItem: camera,
      transactions: [],
      addTime: new Date().toISOString()
    };
    this.selectedEquipment1 = equipmentItem;
  }

  private filterCameras() {
    let filtered = this.allCameras;
    
    // æ–‡æœ¬æœç´¢
    if (this.searchText.trim()) {
      const searchLower = this.searchText.toLowerCase();
      filtered = filtered.filter(camera => 
        camera.Brand.toLowerCase().includes(searchLower) ||
        camera.Model.toLowerCase().includes(searchLower)
      );
    }
    

    
    this.filteredCameras = filtered;
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('å™¨æå¯¹æ¯”')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.primary_text_color'))
      }
      .width('100%')
      .height(56)
      .justifyContent(FlexAlign.Center)
      .backgroundColor($r('app.color.surface_color'))
      .shadow({ radius: 2, color: $r('app.color.shadow_color'), offsetX: 0, offsetY: 1 })

      // å¯æ»šåŠ¨çš„å¯¹æ¯”å†…å®¹
      Scroll() {
        Column() {
        // ç›¸æœºå›¾ç‰‡å±•ç¤ºåŒºåŸŸ
        if (this.selectedEquipment1 && this.selectedEquipment2) {
          Row() {
            // å™¨æ1å›¾ç‰‡
            Column() {
              if (this.selectedEquipment1.cameraDataItem) {
                Image($rawfile(cameraDataJsonService.getCameraImagePath(this.selectedEquipment1.cameraDataItem)))
                  .width(140)
                  .height(105)
                  .borderRadius(12)
                  .objectFit(ImageFit.Cover)
                  .shadow({ radius: 8, color: 'rgba(0,0,0,0.1)', offsetX: 0, offsetY: 4 })
                  .alt($r('app.media.foreground'))
              } else {
                Column() {
                  Text('ğŸ“·')
                    .fontSize(40)
                    .fontColor($r('app.color.tertiary_text_color'))
                }
                .width(140)
                .height(105)
                .backgroundColor($r('app.color.divider_color'))
                .borderRadius(12)
                .justifyContent(FlexAlign.Center)
              }
              
              Text(this.selectedEquipment1.equipmentName)
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor($r('app.color.primary_text_color'))
                .margin({ top: 12 })
                .maxLines(2)
                .textAlign(TextAlign.Center)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Center)
            
            // VSæ ‡è¯†
            Column() {
              Text('VS')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.brand_color'))
                .textShadow({ radius: 2, color: 'rgba(255,107,53,0.3)', offsetX: 0, offsetY: 2 })
            }
            .width(60)
            .justifyContent(FlexAlign.Center)
            
            // å™¨æ2å›¾ç‰‡
            Column() {
              if (this.selectedEquipment2.cameraDataItem) {
                Image($rawfile(cameraDataJsonService.getCameraImagePath(this.selectedEquipment2.cameraDataItem)))
                  .width(140)
                  .height(105)
                  .borderRadius(12)
                  .objectFit(ImageFit.Cover)
                  .shadow({ radius: 8, color: 'rgba(0,0,0,0.1)', offsetX: 0, offsetY: 4 })
                  .alt($r('app.media.foreground'))
              } else {
                Column() {
                  Text('ğŸ“·')
                    .fontSize(40)
                    .fontColor($r('app.color.tertiary_text_color'))
                }
                .width(140)
                .height(105)
                .backgroundColor($r('app.color.divider_color'))
                .borderRadius(12)
                .justifyContent(FlexAlign.Center)
              }
              
              Text(this.selectedEquipment2.equipmentName)
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor($r('app.color.primary_text_color'))
                .margin({ top: 12 })
                .maxLines(2)
                .textAlign(TextAlign.Center)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Center)
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 20, bottom: 24 })
          .backgroundColor($r('app.color.surface_color'))
          .borderRadius({bottomLeft: 16, bottomRight: 16})
          .margin({ left: 16, right: 16, bottom: 16 })
          .shadow({ radius: 6, color: 'rgba(0,0,0,0.08)', offsetX: 0, offsetY: 2 })
        }

        // é€‰æ‹©å™¨æåŒºåŸŸ
        Row() {
          // å™¨æ1é€‰æ‹©
          Column() {
            Text('å™¨æ1')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.secondary_text_color'))
              .margin({ bottom: 8 })

            Button(this.selectedEquipment1 ? this.selectedEquipment1.equipmentName : 'ç‚¹å‡»é€‰æ‹©å™¨æ')
              .width('100%')
              .height(52)
              .fontSize(14)
              .fontColor(this.selectedEquipment1 ? $r('app.color.primary_text_color') : $r('app.color.secondary_text_color'))
              .backgroundColor($r('app.color.card_background_color'))
              .borderRadius(12)
              .border({ width: 1, color: $r('app.color.divider_color') })
              .onClick(() => {
                this.showSelector1 = true;
              })
          }
          .layoutWeight(1)
          .margin({ right: 8 })
          .bindSheet($$this.showSelector1, this.EquipmentSelector(1), {
            height: '60%',
            showClose: false,
            dragBar: true
          })

          // VSæ ‡è¯†
          Text('VS')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.brand_color'))
            .margin({ left: 8, right: 8 })

          // å™¨æ2é€‰æ‹©
          Column() {
            Text('å™¨æ2')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.secondary_text_color'))
              .margin({ bottom: 8 })

            Button(this.selectedEquipment2 ? this.selectedEquipment2.equipmentName : 'ç‚¹å‡»é€‰æ‹©å™¨æ')
              .width('100%')
              .height(52)
              .fontSize(14)
              .fontColor(this.selectedEquipment2 ? $r('app.color.primary_text_color') : $r('app.color.secondary_text_color'))
              .backgroundColor($r('app.color.card_background_color'))
              .borderRadius(12)
              .border({ width: 1, color: $r('app.color.divider_color') })
              .onClick(() => {
                this.showSelector2 = true;
              })
          }
          .layoutWeight(1)
          .margin({ left: 8 })
          .bindSheet($$this.showSelector2, this.EquipmentSelector(2), {
            height: '60%',
            showClose: false,
            dragBar: true
          })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 16 })
        .backgroundColor($r('app.color.surface_color'))
        .borderRadius({bottomLeft: 16, bottomRight: 16})
        .margin({ left: 16, right: 16, bottom: 16 })
        .shadow({ radius: 6, color: 'rgba(0,0,0,0.08)', offsetX: 0, offsetY: 2 })

        // ä¸€é”®æ¸…ç©ºæŒ‰é’®
        if (this.selectedEquipment1 || this.selectedEquipment2) {
          Row() {
            Button('ä¸€é”®æ¸…ç©º')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .backgroundColor('transparent')
              .fontColor($r('app.color.brand_color'))
              .border({ width: 1.5, color: $r('app.color.brand_color') })
              .borderRadius(8)
              .padding({ left: 20, right: 20, top: 10, bottom: 10 })
              .onClick(() => {
                this.selectedEquipment1 = null;
                this.selectedEquipment2 = null;
              })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .padding({ top: 8, bottom: 16, left: 16, right: 16 })
        }

        // å¯¹æ¯”ç»“æœ
        if (this.selectedEquipment1 && this.selectedEquipment2) {
          EnhancedCompareView({
            equipment1: this.selectedEquipment1,
            equipment2: this.selectedEquipment2
          })
            .margin({ left: 16, right: 16 })
        } else {
          Column() {
            Image($r('app.media.icon_compare'))
              .width(64)
              .height(64)
              .fillColor($r('app.color.tertiary_text_color'))
              .margin({ bottom: 16 })

            Text('è¯·é€‰æ‹©ä¸¤ä¸ªå™¨æè¿›è¡Œå¯¹æ¯”')
              .fontSize(16)
              .fontColor($r('app.color.secondary_text_color'))
              .fontWeight(FontWeight.Medium)
              
            Text('é€‰æ‹©å™¨æåå¯æŸ¥çœ‹è¯¦ç»†å‚æ•°å¯¹æ¯”')
              .fontSize(14)
              .fontColor($r('app.color.tertiary_text_color'))
              .margin({ top: 8 })
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .backgroundColor($r('app.color.background_color'))
          .margin({ left: 16, right: 16 })
          .borderRadius(16)
        }
        }
        .width('100%')
      }
      .width('100%')
      .layoutWeight(1)
      .edgeEffect(EdgeEffect.Spring)
      .height('100%')
    }
    .backgroundColor($r('app.color.background_color'))
  }

  @Builder
  CompareResultCard() {
    Column() {
      // å™¨æå›¾ç‰‡å¯¹æ¯”
      Row() {
        // å™¨æ1å›¾ç‰‡
        Column() {
          if (this.selectedEquipment1!.cameraDataItem) {
            Image($rawfile(cameraDataJsonService.getCameraImagePath(this.selectedEquipment1!.cameraDataItem)))
              .width(120)
              .height(90)
              .borderRadius(8)
              .objectFit(ImageFit.Cover)
              .alt($r('app.media.foreground'))
          } else {
            Column() {
              Text('ğŸ“·')
                .fontSize(32)
            }
            .width(120)
            .height(90)
            .backgroundColor($r('app.color.divider_color'))
            .borderRadius(8)
            .justifyContent(FlexAlign.Center)
          }
          
          Text(this.selectedEquipment1!.equipmentName)
            .fontSize(12)
            .fontColor($r('app.color.secondary_text_color'))
            .margin({ top: 8 })
            .maxLines(2)
            .textAlign(TextAlign.Center)
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)
        
        Text('VS')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.brand_color'))
          .margin({ left: 16, right: 16 })
        
        // å™¨æ2å›¾ç‰‡
        Column() {
          if (this.selectedEquipment2!.cameraDataItem) {
            Image($rawfile(cameraDataJsonService.getCameraImagePath(this.selectedEquipment2!.cameraDataItem)))
              .width(120)
              .height(90)
              .borderRadius(8)
              .objectFit(ImageFit.Cover)
              .alt($r('app.media.foreground'))
          } else {
            Column() {
              Text('ğŸ“·')
                .fontSize(32)
            }
            .width(120)
            .height(90)
            .backgroundColor($r('app.color.divider_color'))
            .borderRadius(8)
            .justifyContent(FlexAlign.Center)
          }
          
          Text(this.selectedEquipment2!.equipmentName)
            .fontSize(12)
            .fontColor($r('app.color.secondary_text_color'))
            .margin({ top: 8 })
            .maxLines(2)
            .textAlign(TextAlign.Center)
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
      .padding(16)
      .backgroundColor($r('app.color.card_background_color'))
      .borderRadius(12)
      .margin({ bottom: 16 })
      
      // åŸºæœ¬ä¿¡æ¯å¯¹æ¯”
      Column() {
        Text('åŸºæœ¬ä¿¡æ¯')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.primary_text_color'))
          .margin({ bottom: 16 })
        
        this.CompareRowWithFilter('å™¨æåç§°', this.selectedEquipment1!.equipmentName, this.selectedEquipment2!.equipmentName)
        this.CompareRowWithFilter('å“ç‰Œ', this.selectedEquipment1!.brand, this.selectedEquipment2!.brand)
        this.CompareRowWithFilter('å‹å·', this.selectedEquipment1!.model, this.selectedEquipment2!.model)
        this.CompareRowWithFilter('æ·»åŠ æ—¶é—´', this.formatDate(this.selectedEquipment1!.addTime), this.formatDate(this.selectedEquipment2!.addTime))
        
        // ç›¸æœºè¯¦ç»†å±æ€§å¯¹æ¯”
          if (this.selectedEquipment1!.cameraDataItem && this.selectedEquipment2!.cameraDataItem) {
            this.CompareRowWithFilter('å‘å¸ƒå¹´ä»½', this.selectedEquipment1!.cameraDataItem.Year || 'æœªçŸ¥', this.selectedEquipment2!.cameraDataItem.Year || 'æœªçŸ¥')
            this.CompareRowWithFilter('ä¼ æ„Ÿå™¨å°ºå¯¸', this.selectedEquipment1!.cameraDataItem.SensorSize || 'æœªçŸ¥', this.selectedEquipment2!.cameraDataItem.SensorSize || 'æœªçŸ¥')
            this.CompareRowWithFilter('æœ‰æ•ˆåƒç´ ', this.selectedEquipment1!.cameraDataItem.EffectiveMegapixels || this.selectedEquipment1!.cameraDataItem.Megapixels || 'æœªçŸ¥', this.selectedEquipment2!.cameraDataItem.EffectiveMegapixels || this.selectedEquipment2!.cameraDataItem.Megapixels || 'æœªçŸ¥')
            this.CompareRowWithFilter('ISOèŒƒå›´', this.selectedEquipment1!.cameraDataItem.ISO || 'æœªçŸ¥', this.selectedEquipment2!.cameraDataItem.ISO || 'æœªçŸ¥')
            this.CompareRowWithFilter('æœ€å¤§å…‰åœˆ', this.selectedEquipment1!.cameraDataItem.MaxAperture || 'æœªçŸ¥', this.selectedEquipment2!.cameraDataItem.MaxAperture || 'æœªçŸ¥')
            this.CompareRowWithFilter('è§†é¢‘è§„æ ¼', this.selectedEquipment1!.cameraDataItem.MaxVideoResolution || 'æœªçŸ¥', this.selectedEquipment2!.cameraDataItem.MaxVideoResolution || 'æœªçŸ¥')
            this.CompareRowWithFilter('å±å¹•å°ºå¯¸', this.selectedEquipment1!.cameraDataItem.ScreenSize || 'æœªçŸ¥', this.selectedEquipment2!.cameraDataItem.ScreenSize || 'æœªçŸ¥')
            this.CompareRowWithFilter('å–æ™¯å™¨', this.selectedEquipment1!.cameraDataItem.Viewfinder || 'æœªçŸ¥', this.selectedEquipment2!.cameraDataItem.Viewfinder || 'æœªçŸ¥')
            this.CompareRowWithFilter('å­˜å‚¨ç±»å‹', this.selectedEquipment1!.cameraDataItem.StorageTypes || 'æœªçŸ¥', this.selectedEquipment2!.cameraDataItem.StorageTypes || 'æœªçŸ¥')
            this.CompareRowWithFilter('ç”µæ± ', this.selectedEquipment1!.cameraDataItem.Battery || 'æœªçŸ¥', this.selectedEquipment2!.cameraDataItem.Battery || 'æœªçŸ¥')
            this.CompareRowWithFilter('é‡é‡', this.selectedEquipment1!.cameraDataItem.Weight || 'æœªçŸ¥', this.selectedEquipment2!.cameraDataItem.Weight || 'æœªçŸ¥')
            this.CompareRowWithFilter('å°ºå¯¸', this.selectedEquipment1!.cameraDataItem.Dimensions || 'æœªçŸ¥', this.selectedEquipment2!.cameraDataItem.Dimensions || 'æœªçŸ¥')
          }
      }
      .width('100%')
      .padding(16)
      .backgroundColor($r('app.color.card_background_color'))
      .borderRadius(12)
      .margin({ bottom: 16 })

      // äº¤æ˜“ä¿¡æ¯å¯¹æ¯”
      if (this.selectedEquipment1!.transactions.length > 0 && this.selectedEquipment2!.transactions.length > 0) {
        Column() {
          Text('äº¤æ˜“ä¿¡æ¯')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.primary_text_color'))
            .margin({ bottom: 16 })
          
          this.CompareRowWithFilter('äº¤æ˜“ç±»å‹', 
            this.selectedEquipment1!.transactions[0]?.type === 'buy' ? 'ä¹°å…¥' : 'å–å‡º',
            this.selectedEquipment2!.transactions[0]?.type === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'
          )
          this.CompareRowWithFilter('äº¤æ˜“ä»·æ ¼', 
            (this.selectedEquipment1!.transactions[0]?.price || 0) > 0 ? `Â¥${this.selectedEquipment1!.transactions[0]?.price}` : 'æœªå¡«å†™',
            (this.selectedEquipment2!.transactions[0]?.price || 0) > 0 ? `Â¥${this.selectedEquipment2!.transactions[0]?.price}` : 'æœªå¡«å†™'
          )
          this.CompareRowWithFilter('äº¤æ˜“æ—¥æœŸ', 
            this.selectedEquipment1!.transactions[0]?.date || 'æœªçŸ¥',
            this.selectedEquipment2!.transactions[0]?.date || 'æœªçŸ¥'
          )
        }
        .width('100%')
        .padding(16)
        .backgroundColor($r('app.color.card_background_color'))
        .borderRadius(12)
      }
    }
    .width('100%')
  }

  @Builder
  CompareRow(label: string, value1: string, value2: string) {
    Row() {
      Text(label)
        .fontSize(14)
        .fontColor($r('app.color.secondary_text_color'))
        .width(80)
      
      Text(value1)
        .fontSize(14)
        .fontColor(value1 !== value2 ? $r('app.color.brand_color') : $r('app.color.primary_text_color'))
        .fontWeight(value1 !== value2 ? FontWeight.Medium : FontWeight.Normal)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
      
      Text(value2)
        .fontSize(14)
        .fontColor(value1 !== value2 ? $r('app.color.brand_color') : $r('app.color.primary_text_color'))
        .fontWeight(value1 !== value2 ? FontWeight.Medium : FontWeight.Normal)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .padding({ top: 8, bottom: 8 })
    .border({ width: { bottom: 1 }, color: $r('app.color.divider_color') })
  }
  
  @Builder
  CompareRowWithFilter(label: string, value1: string, value2: string) {
    // å¦‚æœå¼€å¯äº†"ä»…å±•ç¤ºä¸åŒ"å¼€å…³ï¼Œä¸”ä¸¤ä¸ªå€¼ç›¸åŒï¼Œåˆ™ä¸æ˜¾ç¤ºè¯¥è¡Œ
    if (this.showOnlyDifferent && value1 === value2) {
      // ä¸æ¸²æŸ“ä»»ä½•å†…å®¹
    } else {
      Row() {
        Text(label)
          .fontSize(14)
          .fontColor($r('app.color.secondary_text_color'))
          .width(80)
        
        Text(value1)
          .fontSize(14)
          .fontColor(value1 !== value2 ? $r('app.color.brand_color') : $r('app.color.primary_text_color'))
          .fontWeight(value1 !== value2 ? FontWeight.Medium : FontWeight.Normal)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        Text(value2)
          .fontSize(14)
          .fontColor(value1 !== value2 ? $r('app.color.brand_color') : $r('app.color.primary_text_color'))
          .fontWeight(value1 !== value2 ? FontWeight.Medium : FontWeight.Normal)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .padding({ top: 8, bottom: 8 })
      .border({ width: { bottom: 1 }, color: $r('app.color.divider_color') })
    }
  }

  @Builder
  EquipmentSelector(selectorType: number) {
    Column() {
      Text(`é€‰æ‹©å™¨æ${selectorType}`)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.primary_text_color'))
        .margin({ top: 20, bottom: 20 })
      
      // æœç´¢æ¡†
      TextInput({ placeholder: 'æœç´¢ç›¸æœºå“ç‰Œæˆ–å‹å·...', text: this.searchText })
        .width('calc(100% - 32vp)')
        .height(40)
        .borderRadius(8)
        .backgroundColor($r('app.color.card_background_color'))
        .margin({ left: 16, right: 16, bottom: 16 })
        .border({ width: 1, color: $r('app.color.divider_color') })
        .onChange((value: string) => {
          this.searchText = value;
          this.filterCameras();
        })
      
      // Tabåˆ‡æ¢
      Row({space: 25}) {
        Button('æˆ‘çš„å™¨æ')
          .width('40%')
          .height(40)
          .fontSize(14)
          .fontWeight(this.selectedTab === 0 ? FontWeight.Bold : FontWeight.Normal)
          .fontColor(this.selectedTab === 0 ? '#FFFFFF' : $r('app.color.secondary_text_color'))
          .backgroundColor(this.selectedTab === 0 ? $r('app.color.brand_color') : $r('app.color.card_background_color'))
          .borderRadius(0)
          .onClick(() => {
            this.selectedTab = 0;
          })
        
        Button('å…¨éƒ¨ç›¸æœº')
          .width('40%')
          .height(40)
          .fontSize(14)
          .fontWeight(this.selectedTab === 1 ? FontWeight.Bold : FontWeight.Normal)
          .fontColor(this.selectedTab === 1 ? '#FFFFFF' : $r('app.color.secondary_text_color'))
          .backgroundColor(this.selectedTab === 1 ? $r('app.color.brand_color') : $r('app.color.card_background_color'))
          .borderRadius(0)
          .onClick(async () => {
            this.selectedTab = 1;
          })
      }
      .width('calc(100% - 32vp)')
      .margin({ left: 16, right: 16, bottom: 16 })
      .justifyContent(FlexAlign.Center)
      .backgroundColor($r('app.color.divider_color'))
      .borderRadius(8)
      
      // å†…å®¹åŒºåŸŸ
      if (this.selectedTab === 0) {
        // æˆ‘çš„å™¨æåˆ—è¡¨
        if (this.equipmentList.length > 0) {
          List() {
            ForEach(this.equipmentList, (item: MyEquipmentItem) => {
              ListItem() {
                this.EquipmentItemCard(item, selectorType, true)
              }
              .margin({ bottom: 8 })
            })
          }
          .layoutWeight(1)
          .scrollBar(BarState.Auto)
          .padding({ left: 16, right: 16 })
        } else {
          Column() {
            Text('æš‚æ— å™¨æ')
              .fontSize(16)
              .fontColor($r('app.color.secondary_text_color'))
              .margin({ bottom: 8 })
            
            Text('å»æ·»åŠ ä½ çš„ç¬¬ä¸€å°å™¨æå§')
              .fontSize(14)
              .fontColor($r('app.color.tertiary_text_color'))
          }
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        }
      } else {
        // å…¨éƒ¨ç›¸æœºåˆ—è¡¨
        List() {
          ForEach(this.filteredCameras, (camera: CameraDataItem) => {
            ListItem() {
              this.CameraItemCard(camera, selectorType)
            }
            .margin({ bottom: 8 })
          })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Auto)
        .padding({ left: 16, right: 16 })
      }
    }
    .width('100%')
    .height('100%')
  }
  
  @Builder
  EquipmentItemCard(item: MyEquipmentItem, selectorType: number, isMyEquipment: boolean) {
    Row() {
      if (item.cameraDataItem) {
        Image($rawfile(cameraDataJsonService.getCameraImagePath(item.cameraDataItem)))
          .width(50)
          .height(50)
          .borderRadius(8)
          .objectFit(ImageFit.Cover)
          .margin({ right: 12 })
          .alt($r('app.media.foreground'))
      } else {
        Column() {
          Text('ğŸ“·')
            .fontSize(20)
        }
        .width(50)
        .height(50)
        .backgroundColor($r('app.color.divider_color'))
        .borderRadius(8)
        .justifyContent(FlexAlign.Center)
        .margin({ right: 12 })
      }
      
      Column() {
        Text(item.equipmentName)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.primary_text_color'))
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        
        Text(`${item.brand} ${item.model}`)
          .fontSize(14)
          .fontColor($r('app.color.secondary_text_color'))
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      
      if (isMyEquipment) {
        Text('æˆ‘çš„')
          .fontSize(12)
          .fontColor('#4CAF50')
          .backgroundColor('#E8F5E8')
          .padding({ left: 8, right: 8, top: 2, bottom: 2 })
          .borderRadius(4)
          .margin({ right: 8 })
      }
      
      Image($r('sys.media.ohos_ic_public_arrow_right'))
        .width(16)
        .height(16)
        .fillColor($r('app.color.tertiary_text_color'))
    }
    .width('100%')
    .padding(12)
    .backgroundColor($r('app.color.card_background_color'))
    .borderRadius(8)
    .onClick(() => {
      if (selectorType === 1) {
        this.selectedEquipment1 = item;
        this.showSelector1 = false;
      } else {
        this.selectedEquipment2 = item;
        this.showSelector2 = false;
      }
    })
  }
  
  @Builder
  CameraItemCard(camera: CameraDataItem, selectorType: number) {
    Row() {
      Image($rawfile(cameraDataJsonService.getCameraImagePath(camera)))
        .width(50)
        .height(50)
        .borderRadius(8)
        .objectFit(ImageFit.Cover)
        .margin({ right: 12 })
        .alt($r('app.media.foreground'))
      
      Column() {
        Text(`${camera.Brand} ${camera.Model}`)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.primary_text_color'))
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        
        Row() {
          if (camera.Year) {
            Text(camera.Year + 'å¹´')
              .fontSize(12)
              .fontColor($r('app.color.tertiary_text_color'))
              .margin({ right: 8 })
          }

        }
        .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      
      Image($r('sys.media.ohos_ic_public_arrow_right'))
        .width(16)
        .height(16)
        .fillColor($r('app.color.tertiary_text_color'))
    }
    .width('100%')
    .padding(12)
    .backgroundColor($r('app.color.card_background_color'))
    .borderRadius(8)
    .onClick(() => {
      // å°†ç›¸æœºè½¬æ¢ä¸ºMyEquipmentItemæ ¼å¼
      const equipmentItem: MyEquipmentItem = {
        id: Date.now(),
        equipmentName: `${camera.Brand} ${camera.Model}`,
        brand: camera.Brand,
        model: camera.Model,
        cameraDataItem: camera,
        transactions: [],
        addTime: new Date().toISOString()
      };
      
      if (selectorType === 1) {
        this.selectedEquipment1 = equipmentItem;
        this.showSelector1 = false;
      } else {
        this.selectedEquipment2 = equipmentItem;
        this.showSelector2 = false;
      }
    })
  }
  


  private formatDate(dateString: string): string {
    const date = new Date(dateString);
    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
  }
}